<%
  function strip(s) {
    return String(s).replace(/(<([^>]+)>)/gi, "");
  }
%>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Recipe",
      "name": "<%- page.title %>",
      "image": "<%- config.url %>/recipes/images/<%- page.recipeid + '-' + config.language %>.png",
      "author": {
        "@type": "Organization",
        "name": "simpletomake.it"
      },
      "recipeCategory": "<%- page.category %>",
      "keywords": "<%- __('keywords') %>",
      "description": "<% for ( i = 0; i < page.principles.length; i++ ) { %><%- strip(page.principles[ i ]) %>. <% } %>",
      "recipeIngredient": [
        <%

        var ingredients = [],
          ingrSchema = [];

        for ( i = 0; i < page.ingredients.length; i++ ) {
          ingredients.push({
            id: page.ingredients[ i ].id,
            name: page.ingredients[ i ].name,
            qty: +page.ingredients[ i ].qty,
            units: page.ingredients[ i ].units
          })
          var ingredientDataSource = site.pages.filter( p => {
            return ( p.layout === 'ingredient' ) && ( p.id === page.ingredients[ i ].id );
          })
          if ( ingredientDataSource.length ) {
            ingredients[i].name = ingredientDataSource.data[0].name;
          }
        }

        ingredients.forEach( (ing) => {
          if ( ing.name ) {
            ingrSchema.push( ing );
          }
        });

        ingrSchema.forEach( (ing, i) => {
          %>"<% if ( ing.qty ) { %><%- ing.qty %> <%- ing.units %> <% } %><%- ing.name %>"<% if ( i < ingrSchema.length - 1 ) { %>, <% } %><%
        }) %>
      ],
      "aggregateRating": {
        "@type": "AggregateRating", "ratingValue": "5.0", "reviewCount": "<%- 100 +page.directions.length*13 %>"
      },
      "recipeInstructions": [<% for ( i = 0; i < page.directions.length; i++ ) { %>
        { "@type": "HowToStep", "text": "<%- strip(page.directions[ i ]) %>" }<% if ( i < page.directions.length - 1 ) { %>, <% } %><%Â } %>
      ]
    }
  </script>

  <script type="module">
import { annotate, annotationGroup } from 'https://unpkg.com/rough-notation?module';
var el = document.querySelectorAll('.recipeheader-main li strong'), annotations = [];
Array.from( el ).forEach( line => { annotations.push( annotate(line, { type: 'highlight', color: 'rgba(255,223,47,0.4)', multiline: true }) ); });
annotationGroup( annotations ).show();
  </script>